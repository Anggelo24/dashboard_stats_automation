<!DOCTYPE html>
<html>
<head>
  <title>Check Table Schema</title>
  <style>
    body {
      font-family: monospace;
      background: #1a1a1a;
      color: #fff;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    button {
      background: #6366f1;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 0;
    }
    button:hover { background: #5558e3; }
    pre {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      border-left: 4px solid #6366f1;
    }
    .error { border-left-color: #ef4444; }
    .success { border-left-color: #10b981; }
  </style>
</head>
<body>
  <h1>üîç Supabase Table Schema Check</h1>
  <button onclick="checkSchema()">Check workflow_executions Schema</button>
  <button onclick="fetchActualData()">Fetch Sample Data</button>
  <div id="output"></div>

  <script>
    const SUPABASE_URL = 'https://cdgolvcyibkdcpoqbifv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNkZ29sdmN5aWJrZGNwb3FiaWZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjY0OTIsImV4cCI6MjA3ODMwMjQ5Mn0.7rxnYNKDakBuvG_11KIsalGlgSJI4fyqjbbq79k-FbY';
    const CLIENT_ID = '2e75e60c-2362-42d1-8300-225944efb8db';

    async function checkSchema() {
      const output = document.getElementById('output');
      output.innerHTML = '<h2>Fetching one row to check schema...</h2>';

      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/workflow_executions?limit=1`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
          }
        });

        if (!response.ok) {
          const error = await response.text();
          output.innerHTML += `<pre class="error">‚ùå Error: ${response.status}\n${error}</pre>`;
          return;
        }

        const data = await response.json();

        if (data.length === 0) {
          output.innerHTML += '<pre class="error">‚ùå Table is empty!</pre>';
          return;
        }

        const firstRow = data[0];
        const columns = Object.keys(firstRow);

        const expectedColumns = [
          'id',
          'client_id',
          'workflow_id',
          'workflow_name',
          'event_type',
          'timestamp',
          'status',
          'metadata',
          'created_at'
        ];

        let schemaHTML = '<h2>‚úÖ Schema Analysis:</h2>';
        schemaHTML += '<h3>Columns in your table:</h3>';
        schemaHTML += '<pre class="success">' + columns.map(col => `  ‚úì ${col}`).join('\n') + '</pre>';

        schemaHTML += '<h3>Expected vs Actual:</h3>';
        const missing = [];
        const extra = [];

        expectedColumns.forEach(col => {
          if (!columns.includes(col)) {
            missing.push(col);
          }
        });

        columns.forEach(col => {
          if (!expectedColumns.includes(col)) {
            extra.push(col);
          }
        });

        if (missing.length > 0) {
          schemaHTML += '<pre class="error">‚ùå MISSING columns:\n' + missing.map(c => `  - ${c}`).join('\n') + '</pre>';
        }

        if (extra.length > 0) {
          schemaHTML += '<pre>‚ÑπÔ∏è Extra columns (OK):\n' + extra.map(c => `  + ${c}`).join('\n') + '</pre>';
        }

        if (missing.length === 0) {
          schemaHTML += '<pre class="success">‚úÖ All required columns present!</pre>';
        }

        schemaHTML += '<h3>Sample Row Data:</h3>';
        schemaHTML += '<pre>' + JSON.stringify(firstRow, null, 2) + '</pre>';

        output.innerHTML += schemaHTML;

      } catch (error) {
        output.innerHTML += `<pre class="error">‚ùå Error: ${error.message}</pre>`;
      }
    }

    async function fetchActualData() {
      const output = document.getElementById('output');
      output.innerHTML = '<h2>Fetching data with the same query the app uses...</h2>';

      try {
        // Same query as the app
        const days = 7;
        const dateFilter = new Date();
        dateFilter.setDate(dateFilter.getDate() - days);
        const dateString = dateFilter.toISOString();

        const query = `${SUPABASE_URL}/rest/v1/workflow_executions?client_id=eq.${CLIENT_ID}&timestamp=gte.${dateString}&order=timestamp.desc&limit=100`;

        output.innerHTML += '<pre>Query URL:\n' + query + '</pre>';

        const response = await fetch(query, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
          }
        });

        output.innerHTML += `<pre>Response Status: ${response.status}</pre>`;

        if (!response.ok) {
          const error = await response.text();
          output.innerHTML += `<pre class="error">‚ùå Query Failed:\n${error}</pre>`;

          if (error.includes('column') && error.includes('does not exist')) {
            output.innerHTML += '<pre class="error">üîç FOUND THE ISSUE!\nThe "timestamp" column is missing or has a different name!</pre>';
          }
          return;
        }

        const data = await response.json();

        if (data.length === 0) {
          output.innerHTML += '<pre class="error">‚ö†Ô∏è Query returned 0 rows.\nPossible reasons:\n1. No data in last 7 days\n2. timestamp column has NULL values\n3. Data is too old</pre>';

          // Try without date filter
          output.innerHTML += '<h3>Trying without date filter...</h3>';
          const response2 = await fetch(`${SUPABASE_URL}/rest/v1/workflow_executions?client_id=eq.${CLIENT_ID}&limit=10`, {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            }
          });
          const data2 = await response2.json();
          output.innerHTML += `<pre class="success">‚úÖ Found ${data2.length} rows without date filter!\n${JSON.stringify(data2, null, 2)}</pre>`;
        } else {
          output.innerHTML += `<pre class="success">‚úÖ Query successful! Found ${data.length} rows:\n${JSON.stringify(data, null, 2)}</pre>`;
        }

      } catch (error) {
        output.innerHTML += `<pre class="error">‚ùå Error: ${error.message}\n${error.stack}</pre>`;
      }
    }
  </script>
</body>
</html>
